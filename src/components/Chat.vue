<template>
  <div v-if="!chatMode" class="buttonPos">
    <div class="chat">
      <svg
        @click="chatMode = true"
        t="1739245600813"
        class="icon"
        viewBox="0 0 1095 1024"
        version="1.1"
        xmlns="http://www.w3.org/2000/svg"
        p-id="10116"
        width="48"
        height="48"
      >
        <path
          d="M606.082246 72.596211l-216.459228-32.336843 89.824561-40.259368 216.477193 32.336842-89.824561 40.259369z"
          fill="#CECEF9"
          p-id="10117"
        ></path>
        <path
          d="M389.640982 40.259368v98.088421l89.824562-40.277333v-98.088421l-89.824562 40.277333z"
          fill="#CECEF9"
          p-id="10118"
        ></path>
        <path
          d="M389.640982 138.329825l64.925193 9.701052 89.824562-40.241403-64.925193-9.719018-89.824562 40.259369z"
          fill="#CECEF9"
          p-id="10119"
        ></path>
        <path
          d="M454.566175 148.030877v49.044211l89.824562-40.259369v-49.04421l-89.824562 40.259368z"
          fill="#CECEF9"
          p-id="10120"
        ></path>
        <path
          d="M454.566175 197.075088L129.886316 148.569825l89.824561-40.277334 324.697825 48.505263-89.824562 40.277334z"
          fill="#CECEF9"
          p-id="10121"
        ></path>
        <path
          d="M129.886316 148.569825v760.095438l89.824561-40.241403V108.274526l-89.824561 40.277334z"
          fill="#CECEF9"
          p-id="10122"
        ></path>
        <path
          d="M129.886316 908.665263l735.950596 109.981193 89.824562-40.259368-735.950597-109.981193-89.824561 40.277333z"
          fill="#CECEF9"
          p-id="10123"
        ></path>
        <path
          d="M865.836912 1018.646456v-760.095438l89.824562-40.277334v760.095439l-89.824562 40.277333zM865.836912 258.533053l-324.679859-48.505264 89.824561-40.277333 324.67986 48.505263-89.824562 40.277334z"
          fill="#CECEF9"
          p-id="10124"
        ></path>
        <path
          d="M541.157053 210.009825V160.965614l89.824561-40.241403v49.026245l-89.824561 40.259369z"
          fill="#CECEF9"
          p-id="10125"
        ></path>
        <path
          d="M541.157053 160.965614l64.925193 9.701053 89.824561-40.241404-64.925193-9.701052-89.824561 40.241403z"
          fill="#CECEF9"
          p-id="10126"
        ></path>
        <path
          d="M606.082246 170.684632v-98.088421l89.824561-40.259369v98.088421l-89.824561 40.259369zM606.082246 72.596211l89.824561-40.259369-89.824561 40.259369zM216.459228 823.529544V259.592982l89.824561-40.259368V783.270175l-89.824561 40.259369z"
          fill="#CECEF9"
          p-id="10127"
        ></path>
        <path
          d="M216.459228 259.592982l562.786807 84.07579 89.824561-40.259368-562.786807-84.093755-89.824561 40.259369zM779.264 343.668772v563.972491l89.824561-40.277333V303.427368l-89.824561 40.277334z"
          fill="#CECEF9"
          p-id="10128"
        ></path>
        <path
          d="M779.246035 907.641263L216.477193 823.511579l89.824561-40.259368 562.786807 84.093754-89.824561 40.277333zM216.459228 823.529544l89.824561-40.259369-89.824561 40.259369zM0 374.352842v269.725193l89.824561-40.277333V334.093474l-89.824561 40.259368z"
          fill="#CECEF9"
          p-id="10129"
        ></path>
        <path
          d="M0 644.078035l86.590877 12.934737 89.824562-40.277333L89.824561 603.800702l-89.824561 40.277333z"
          fill="#CECEF9"
          p-id="10130"
        ></path>
        <path
          d="M86.590877 657.012772V387.287579l89.824562-40.259368V616.735439l-89.824562 40.241403z"
          fill="#CECEF9"
          p-id="10131"
        ></path>
        <path
          d="M86.590877 387.287579L0 374.352842l89.824561-40.259368 86.590878 12.934737-89.824562 40.259368zM0 374.352842l89.824561-40.259368-89.824561 40.259368zM909.132351 510.203509v269.725193l89.824561-40.277334V469.962105l-89.824561 40.259369z"
          fill="#CECEF9"
          p-id="10132"
        ></path>
        <path
          d="M909.132351 779.928702l86.590877 12.934737 89.824561-40.277334-86.590877-12.934737-89.824561 40.277334z"
          fill="#CECEF9"
          p-id="10133"
        ></path>
        <path
          d="M995.723228 792.863439V523.138246l89.824561-40.259369v269.707228l-89.824561 40.277334z"
          fill="#CECEF9"
          p-id="10134"
        ></path>
        <path
          d="M995.723228 523.138246l-86.590877-12.934737 89.824561-40.259369 86.590877 12.934737-89.824561 40.259369zM909.132351 510.203509l89.824561-40.259369-89.824561 40.259369zM432.918456 512.610807l-108.220631-16.168421 89.824561-40.277333 108.220632 16.168421-89.824562 40.259368z"
          fill="#CECEF9"
          p-id="10135"
        ></path>
        <path
          d="M324.697825 496.424421v122.610526l89.824561-40.277333v-122.592561l-89.824561 40.259368z"
          fill="#CECEF9"
          p-id="10136"
        ></path>
        <path
          d="M324.697825 619.034947l108.220631 16.168421 89.824562-40.259368-108.220632-16.168421-89.824561 40.241403z"
          fill="#CECEF9"
          p-id="10137"
        ></path>
        <path
          d="M432.918456 635.203368v-122.592561l89.824562-40.277333v122.610526l-89.824562 40.259368zM432.918456 512.610807l89.824562-40.277333-89.824562 40.277333zM671.025404 548.181333l-108.220632-16.168421 89.824561-40.259368 108.220632 16.168421-89.824561 40.259368z"
          fill="#CECEF9"
          p-id="10138"
        ></path>
        <path
          d="M562.804772 532.012912v122.592562l89.824561-40.259369v-122.592561l-89.824561 40.259368z"
          fill="#CECEF9"
          p-id="10139"
        ></path>
        <path
          d="M562.804772 654.605474l108.220632 16.168421 89.824561-40.259369-108.220632-16.168421-89.824561 40.259369z"
          fill="#CECEF9"
          p-id="10140"
        ></path>
        <path
          d="M671.025404 670.79186v-122.610527l89.824561-40.259368v122.592561l-89.824561 40.277334zM671.025404 548.181333l89.824561-40.259368-89.824561 40.259368z"
          fill="#CECEF9"
          p-id="10141"
        ></path>
        <path
          d="M606.082246 72.596211l-216.459228-32.336843v98.088421l64.943157 9.701053v49.044211L129.868351 148.569825v760.095438l735.968561 109.981193v-760.095438L541.157053 210.009825V160.965614l64.925193 9.701053V72.578246z m-389.623018 750.933333V259.592982l562.804772 84.11172v563.954526L216.459228 823.511579zM0 374.352842v269.725193l86.590877 12.934737V387.287579L0 374.352842zM909.132351 510.203509v269.725193l86.590877 12.934737V523.138246l-86.590877-12.934737z m-476.213895 2.407298l-108.220631-16.168421v122.592561l108.220631 16.168421v-122.592561z m238.106948 35.570526l-108.220632-16.168421v122.592562l108.220632 16.168421v-122.592562z"
          fill="#4E5969"
          p-id="10142"
        ></path>
      </svg>
    </div>
  </div>

  <div
    ref="chatWinRef"
    :style="{ '--window-Width': windowWidth + 'px', top: windowState.pos.y + 'px', left: windowState.pos.x + 'px' }"
    class="chatPos"
    v-else
  >
    <div class="chat">
      <div class="chat-app">
        <div class="chat-app-title" @mousedown="startDrag">
          <div class="draggable">小易助手</div>
          <el-space>
            <el-icon title="新建" class="button-icon" @click="messages = []"><Plus /></el-icon>
            <el-icon title="关闭" class="button-icon" @click="close"><Close /></el-icon>
          </el-space>
        </div>

        <div class="chat-app-body">
          <el-scrollbar ref="scrollRef" height="400px">
            <template v-for="(msg, index) in messages">
              <div class="chat-app-body-msg" v-if="msg.type == 'user'">
                <div class="chat-app-body-msg-container">{{ msg.message }}</div>
              </div>

              <div class="chat-app-body-system" v-else>
                <div
                  v-if="msg.message != ''"
                  :class="{ loading: loading && index == messages.length - 1 }"
                  class="chat-app-body-system-container"
                >
                  <Markdown :source="msg.message" />
                </div>
              </div>
            </template>
          </el-scrollbar>
        </div>

        <div class="chat-app-input">
          <el-input :readonly="loading" @keydown.enter="send" v-model="message" placeholder="请输入内容" focus>
            <template #suffix>
              <el-icon v-show="!loading" @click="send" class="button-icon"><Position /></el-icon>
              <el-icon v-show="loading" @click="cancelSend" class="button-icon"><VideoPause /></el-icon>
            </template>
          </el-input>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
  import { Close, Position, Plus, VideoPause } from '@element-plus/icons-vue'
  import Markdown from 'vue3-markdown-it'
  import 'highlight.js/styles/github.css'
  const apiUrl = 'http://127.0.0.1:11434/api/chat'
  const chatWinRef = ref()
  const chatMode = ref(false)
  const message = ref('')
  const windowWidth = ref(600)
  const windowState = reactive({
    pos: { x: window.innerWidth - windowWidth.value - 18, y: 200 },
    offset: { x: 0, y: 0 },
    dragging: false,
    containerWidth: window.innerWidth,
    containerHeight: window.innerHeight,
    elementWidth: 0,
    elementHeight: 0,
  })
  const messages = ref<Array<any>>([])
  const scrollRef = ref()
  const loading = ref(false)
  const eventSource = ref<EventSource>()
  const controller = ref()

  const cancelSend = () => {
    loading.value = false
    controller.value.abort()
    // eventSource.value?.close()
  }

  const startDrag = (e: any) => {
    windowState.dragging = true

    windowState.offset.x = e.clientX - windowState.pos.x
    windowState.offset.y = e.clientY - windowState.pos.y

    document.addEventListener('mousemove', onDrag)
    document.addEventListener('mouseup', endDrag)
  }

  const onDrag = (e: any) => {
    if (windowState.dragging) {
      let newX = e.clientX - windowState.offset.x
      let newY = e.clientY - windowState.offset.y

      // 限制 x 坐标
      newX = Math.max(0, Math.min(windowState.containerWidth - windowState.elementWidth, newX))

      // 限制 y 坐标
      newY = Math.max(0, Math.min(windowState.containerHeight - windowState.elementHeight, newY))

      windowState.pos.x = newX
      windowState.pos.y = newY
    }
  }

  // 鼠标松开时触发，结束拖动
  const endDrag = () => {
    windowState.dragging = false
    document.removeEventListener('mousemove', onDrag)
    document.removeEventListener('mouseup', endDrag)
  }

  const chatStreaming = async () => {
    try {
      // 发起 fetch 请求
      controller.value = new AbortController()
      const signal = controller.value.signal

      const response = await fetch(apiUrl, {
        signal,
        method: 'POST',
        keepalive: true,
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'qwen2.5:3b',
          messages: [
            {
              role: 'user',
              content: message.value,
            },
          ],
        }),
      })
      message.value = ''
      // 检查响应是否成功
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`)
      }

      // 获取 ReadableStream
      const reader = response.body?.getReader()
      const decoder = new TextDecoder('utf-8')

      if (reader) {
        // 持续读取流数据
        let chunk
        let buf = ''
        while (true) {
          const { done, value } = await reader.read()

          if (done) {
            console.log('Stream complete')
            break
          }

          try {
            chunk = decoder.decode(value, { stream: true })
            // console.log(chunk)
            const chunks = chunk.split('\n')
            for (const c of chunks) {
              if (c != '') {
                const msg = JSON.parse(c)
                messages.value[messages.value.length - 1].message += msg.message.content.replace(/\\n/g, '\r\n')
                scrollRef.value?.setScrollTop(scrollRef.value.scrollHeight)
              }
            }
          } catch (error) {
            console.error(error)
            // console.warn(chunk.split('\n'))
          }
        }
        console.log(buf)
        loading.value = false
      }
    } catch (error) {
      console.error('Error fetching streaming data:', error)
    }
  }

  const send = async () => {
    messages.value.push({
      type: 'user',
      message: message.value,
    })

    messages.value.push({
      type: 'system',
      message: '',
    })
    // eventSource.value = new EventSource('http://172.29.0.1:8080/sse?prompt=' + message.value)
    loading.value = true
    // eventSource.value.onmessage = function (event) {
    //   const m = event.data.replace(/@@/g, '\r\n')

    //   messages.value[messages.value.length - 1].message += m
    //   if (scrollRef.value?.wrapRef?.scrollHeight) {
    //     scrollRef.value?.setScrollTop(scrollRef.value?.wrapRef?.scrollHeight)
    //   }
    // }

    // eventSource.value.onerror = function (error) {
    //   console.error('SSE 连接错误:', error)
    //   eventSource.value?.close()
    //   loading.value = false
    // }
    await chatStreaming()

    scrollRef.value?.setScrollTop(scrollRef.value.scrollHeight)
  }

  const close = () => {
    messages.value = []
    chatMode.value = false
  }

  const updateContainerSize = () => {
    windowState.containerWidth = window.innerWidth
    windowState.containerHeight = window.innerHeight
  }

  watch(chatMode, (val) => {
    if (val) {
      const el = chatWinRef.value
      if (el) {
        windowState.elementWidth = el.offsetWidth
        windowState.elementHeight = el.offsetHeight
      }
    }
  })

  onMounted(() => {
    window.addEventListener('resize', updateContainerSize)
  })

  onUnmounted(() => {
    window.removeEventListener('resize', updateContainerSize)
  })
</script>

<style lang="scss" scoped>
  $radius: 6px;
  :deep(.hljs) {
    border-radius: 10px;
    width: var(--window-Width);
    overflow: auto;
  }
  .loading {
    color: #aaa;
  }
  .icon {
    cursor: pointer;
  }
  .chatPos {
    position: fixed;
    right: 20px;
    top: 20%;
    z-index: 1000;
  }
  .buttonPos {
    position: fixed;
    right: 20px;
    top: 40%;
    z-index: 1000;
  }
  .button-icon {
    color: #888;
    cursor: pointer;
    font-size: 14px;
    &:hover {
      color: #222;
    }
  }
  .draggable {
    text-align: center;
    border-radius: 8px;
    cursor: grab;
    width: 90%;
    user-select: none;
  }
  .draggable:active {
    cursor: grabbing;
  }
  .chat {
    display: flex;

    &-app {
      width: var(--window-Width);
      min-width: var(--window-Width);
      background-color: #fff;
      box-shadow: 0px 0px 6px 1px rgba(0, 0, 0, 0.1);
      border: 1px solid #cccccc;
      border-radius: 6px;
      // padding: 12px;
      &-title {
        user-select: none;
        font-size: 13px;
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #cccccc;
        padding: 6px;
        color: #222222;
      }
      &-body {
        padding: 6px;
        background-color: #fefefe;
        &-msg {
          display: flex;
          justify-content: flex-end;
          &-container {
            font-size: 12px;
            margin: 6px;
            background-color: #eff6ff;
            padding: 8px 12px;
            border-radius: $radius;
          }
        }
        &-system {
          width: calc(var(--window-Width) - 34px);
          text-wrap: wrap;
          display: flex;
          justify-content: flex-start;
          &-container {
            font-size: 12px;
            margin: 6px;
            background-color: #fcfcfc;
            padding: 8px 12px;
            border-radius: $radius;
            :deep(p) {
              margin: 0;
            }
          }
        }
      }
      &-input {
        // margin: 6px;
        padding: 6px;
        border-top: 1px solid #ececec;
      }
    }
  }
</style>
